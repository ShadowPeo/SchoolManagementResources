## Temporary Fix for CVE-2022-30190
## Default action is to remove the vulnrability, if restore action is required then you need to flag it
 param (
    [switch]$restore = $false
 )

    if($restore -eq $false -and ((Test-Path -Path registry::HKEY_CLASSES_ROOT\ms-msdt) -eq $true)) #Backup the key to another registry key, mitigating the issue
    {
        try
        {
            New-PSDrive -PSProvider registry -Root HKEY_CLASSES_ROOT -Name HKCR ##Connect to the registry
            Set-Item -Path "HKCR:\ms-msdt" -Value "URL:ms-msdt_bak" ##Set the MS-MSDT Registry Value to MS-MSDT_BAK
            Rename-Item -Path "HKCR:\ms-msdt" -newName "ms-msdt_bak" ##Rename the MS-MSDT Registry to MS-MSDT_BAK
            exit 0
        }
        catch
        {
            exit 1
        }
    } 
    elseif ($restore -eq $true -and ((Test-Path -Path registry::HKEY_CLASSES_ROOT\ms-msdt_bak) -eq $true)) #Check to see if restore is needed, and path exists (as in created by this script)
    {
        try
        {
            New-PSDrive -PSProvider registry -Root HKEY_CLASSES_ROOT -Name HKCR ##Connect to the registry
            Rename-Item -Path "HKCR:\ms-msdt_bak" -newName "ms-msdt" ##Set the MS-MSDT_BAK Registry  Value to MS-MSDT
            Set-Item -Path "HKCR:\ms-msdt" -Value "URL:ms-msdt" ##Rename the MS-MSDT_BAK Registry to MS-MSDT
            exit 0
        }
        catch
        {
            exit 1
        }
    }
    elseif (((Test-Path -Path registry::HKEY_CLASSES_ROOT\ms-msdt) -eq $false)) #Check to see if mitigation is not needed in case other method used
    {
        exit 0
    }
    exit 1